[~, userID] = system('whoami');
userID = strtrim(userID);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MelanopsinStepsFovealControlShortDuration1_5sPulse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
params = PupilAnalysisToolbox_GetDefaultParams;
params.StepDurSecs = 1;

Subjects = {'M012216S' 'J012216R' 'G012216A'};
Protocols={'MelanopsinStepsFovealControlShortDuration1_5sPulse'};

basePath = ['/Users/' userID '/Dropbox (Aguirre-Brainard Lab)/MELA_data/MelanopsinStepsFovealControlShortDuration1_5sPulse'];
resultsPath = ['/Users/' userID '/Dropbox (Aguirre-Brainard Lab)/MELA_analysis/MelanopsinStepsFovealControlShortDuration1_5sPulse'];

newLabels = {'Background', 'LMS+', 'Mel+', 'Cone noise'};
oldLabels = {'Background-60s', 'LMSDirectedNulled-45sPositivePulse1_5sConeNoise', 'MelanopsinDirectedPenumbralIgnoreNulled-45sPositivePulse1_5sConeNoise', 'ConeNoiseOnly-45s'};
Data = PupilAnalysisToolbox_PulseSequentialTrialAnalysis(params, Subjects, Protocols, newLabels, oldLabels, basePath, resultsPath);
%%
ylimVal = 0.4;
for dd = 1:size(Data, 2)
    figure;
    hold on;
    plot([5 5], [-ylimVal ylimVal], 'r');
    plot([min(Data(1, dd).t) max(Data(1, dd).t)], [0 0], '-k');
    shadedErrorBar(Data(1, dd).t, nanmean([Data(:, dd).AvgTimeSeries], 2), nanstd([Data(:, dd).AvgTimeSeries], [], 2)/sqrt(size([Data(:, dd).AvgTimeSeries], 2)));
    xlabel('Time [s]');
    ylabel('\Delta%');
    pbaspect([1 1 1]);
    title({strrep(Data(1, dd).label, '_', ' ')});
    ylim([-ylimVal ylimVal]);
    set(gca, 'TickDir', 'out');
end
%%
figure;
subjectCols = [224 236 244 ; 158 188 218 ; 136 86 167]/255;
nSubjects = size(Data, 1);
nConds = size(Data, 2);
shiftVals = [-0.1 0 0.1];
for dd = 1:size(Data, 2)
    hold on;
    for ii = 1:nSubjects
       tmp = plot(Data(ii, dd).Mean, dd+shiftVals(ii), 's', 'MarkerEdgeColor', 'k', 'MarkerFaceColor', subjectCols(ii, :), 'MarkerSize', 8);
       h(ii) = tmp(1);
       plot([mean(Data(ii, dd).Mean) mean(Data(ii, dd).Mean)], [dd+shiftVals(ii)+shiftVals(1) dd+shiftVals(ii)+shiftVals(end)], '-', 'Color', subjectCols(ii, :), 'LineWidth', 3);
    end
    xlabel('Diameter [mm]');
    ylabel('Condition');
    pbaspect([1 0.7 1]);
    xlim([1 9]); ylim([0.5 nSubjects+0.5]);
    title('Pupil mean');
end
set(gca, 'YTick', 1:nConds, 'YTickLabel', {Data(1, :).label});
legend(h, Subjects, 'Location', 'NorthEast'); legend boxoff;

set(gca, 'TickDir', 'out');
set(gcf, 'PaperPosition', [0 0 4 4]); %Position plot at left hand corner with width 15 and height 6.
set(gcf, 'PaperSize', [4 4]); %Set the paper to have width 15 and height 6.
saveas(gcf, fullfile(resultsPath, [char(Subjects(SubjectID)) '_PupilPulseData_' UniqueDirectionLabels{d} '.pdf'], 'pdf');
close(gcf);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MelanopsinStepsFovealControlShortDuration5_5sPulse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
params = PupilAnalysisToolbox_GetDefaultParams;
params.StepDurSecs = 5.5;

Subjects = {'J012216R'  'M012216S'  'G012216A'};
Protocols={'MelanopsinStepsFovealControlShortDuration5_5sPulse'};

basePath = ['/Users/' userID '/Dropbox (Aguirre-Brainard Lab)/MELA_data/MelanopsinStepsFovealControlShortDuration5_5sPulse'];
resultsPath = ['/Users/' userID '/Dropbox (Aguirre-Brainard Lab)/MELA_analysis/MelanopsinStepsFovealControlShortDuration5_5sPulse'];

newLabels = {'Background', 'LMS+', 'Mel+', 'Cone noise'};
oldLabels = {'Background-60s', 'LMSDirectedNulled-45sPositivePulse5_5sConeNoise', 'MelanopsinDirectedPenumbralIgnoreNulled-45sPositivePulse5_5sConeNoise', 'ConeNoiseOnly-45s'};
PupilAnalysisToolbox_PulseSequentialTrialAnalysis(params, Subjects, Protocols, newLabels, oldLabels, basePath, resultsPath);



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Mel5_5sPulseFoveal
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
params = PupilAnalysisToolbox_GetDefaultParams;
params.StepDurSecs = 5.5;

Subjects = {'J012216R_foveal'};
Protocols={'Mel5_5sPulseFoveal'};

basePath = ['/Users/' userID '/Dropbox (Aguirre-Brainard Lab)/MELA_data/Mel5_5sPulseFoveal'];
resultsPath = ['/Users/' userID '/Dropbox (Aguirre-Brainard Lab)/MELA_analysis/Mel5_5sPulseFoveal'];
newLabels = {'Background', 'LMS+', 'Mel+', 'Cone noise'};
oldLabels = {'Background-60s', 'LMSDirectedNulledFoveal-45sPositivePulse5_5sConeNoise', 'MelanopsinDirectedPenumbralIgnoreNulledFoveal-45sPositivePulse5_5sConeNoise', 'ConeNoiseOnly-45s'};
PupilAnalysisToolbox_PulseSequentialTrialAnalysis(params, Subjects, Protocols, newLabels, oldLabels, basePath, resultsPath);
